const e=document.getElementById("m"),t=document.getElementById("b"),l=document.getElementById("s");function s(e,t){return e=Math.ceil(e),t=Math.floor(t)+1,Math.floor(Math.random()*(t-e))+e}window.g={t:{},r:{},lvl:{lvl:1},shA:1,blA:1,scA:2,q:2,b:1,mb:1,bb:2,st:120,sRow:4,sRp:4,s:1,tileCount:0,tileSessionCount:0,ani:500,tool:"de",throttle:!1};const n=window.g;class a{constructor(e){e||(e={row:0});let t={type:e.type?e.type:"?",elm:document.createElement("div"),innerElm:document.createElement("div"),id:window.tileCount,row:e.row||0===e.row?e.row:99,rp:e.rp||0===e.rp?e.rp:99,d:!!e.done&&e.done,b:0,ani:""};return n.tileCount++,n.tileSessionCount++,t.obj=this,t.elm.appendChild(t.innerElm),t.elm.onmousedown=e=>{2!==e.buttons&&"sc"!==n.tool&&(t.elm.classList.add("p"),setTimeout((()=>{t.elm.classList.remove("p")}),n.ani/2))},t.elm.onmouseup=()=>{t.elm.classList.remove("p")},t.elm.onclick=()=>{this.action(t)},n.r[t.row]?n.r[t.row][t.rp]=t:n.r[t.row]={[t.rp]:t},n.t[Object.keys(n.t).length]=t,s(0,10)>5&&t.elm.setAttribute("m",1),s(0,10)>5&&t.elm.setAttribute("n",2),s(0,10)>5&&t.elm.setAttribute("o",3),t}gainType=(e,t)=>{if("q"!==t)e.type=t;else{let t=s(0,2),l="sc";1===t&&(l="sh"),2===t&&(l="bl"),e.q=l}};destroy=e=>{e.dd=!0,"b"===e.type&&n.b--,this.dead(e,"d")};action=e=>{let t=!0;if(n.block)return!1;"bl"===n.tool&&n.blA>0?(this.destroy(e),n.ga("bl",-1)):"sc"===n.tool&&n.scA>0?(this.seeAdjacent(e),n.ga("sc",-1)):("de"===n.tool&&!e.d||"de"===n.tool&&e.q)&&(e.elm.setAttribute("c","true"),e.q&&!e.val&&(n.ga(e.q,1),e.q=!1,e.elm.removeAttribute("q")),"b"===e.type?(e.innerElm.innerHTML="üëæ",e.obj.ani(e,"b"),this.revealTile(e),n.dmg(-1),t=!1):"?"===e.type&&this.cascade(e)),t&&this.postAction(e)};postAction=e=>{setTimeout((()=>{n.up()}),n.ani)};revealTile=e=>{e.elm.setAttribute("r","true"),n.tilesLeft--};cascade=(e,t)=>{let l=this.adjacent(e);this.revealTile(e);let s=0;e.val=0,e.innerElm.innerHTML="";for(let e=0;e<Object.keys(l).length;e++){let t=l[e];"b"!==t.type||t.dd||s++}if(s>0&&!e.d)e.innerElm.innerHTML=s,e.val=s;else if("b"===e.type);else if(e.q)e.elm.setAttribute("q",e.q);else if(!t){this.dead(e);for(let t=0;t<Object.keys(l).length;t++)(!l[t].elm.getAttribute("r")||l[t].elm.getAttribute("r")&&e.rev)&&(l[t].rev=!1,this.cascade(l[t]))}t&&(e.innerElm.innerHTML="",s>0&&"b"!==e.type?(e.innerElm.innerHTML=s,e.val=s):"b"!==e.type||e.dd||(e.innerElm.innerHTML="üëæ"),this.ani(e,"rev"),e.rev=!0)};dead=(e,t)=>{if(t||(t=""),"d"===t){let t={elm:e.elm.cloneNode(!0)};e.elm.appendChild(t.elm),this.ani(t,"deadB",!0)}this.ani(e,"dead "+t),e.d=!0};seeAdjacent=e=>{let t=this.adjacent(e);this.cascade(e,!0);for(let e=0;e<Object.keys(t).length;e++){let l=t[e];this.cascade(l,!0)}};adjacent=e=>{let t=e.rp,l=e.row,s={},a=e=>{s[Object.keys(s).length]=e};return l-1>=0&&(t-1>=0&&a(n.r[l-1][t-1]),a(n.r[l-1][t]),t+1<n.tr&&a(n.r[l-1][t+1])),t-1>=0&&a(n.r[l][t-1]),t+1<n.tr&&a(n.r[l][t+1]),l+1<n.rows&&(t-1>=0&&a(n.r[l+1][t-1]),a(n.r[l+1][t]),t+1<n.tr&&a(n.r[l+1][t+1])),s};ani=(e,t,l)=>{e.d&&"rev"!==t&&e.d&&"dead d"!==t||(""!==e.ani&&(e.ani="",e.elm.className=""),window.requestAnimationFrame((()=>{"rev"===t&&(t=t+" "+e.ani),e.ani=t,e.elm.className=t,"deadB"===t&&window.requestAnimationFrame((()=>{let t=e.elm.style;t.opacity=.1,t.transform="scale(0.1)"})),setTimeout((()=>{e.d||e.elm.className!==t||(e.elm.className=""),(e.d&&e.elm.classList.contains("rev")||e.dd)&&(e.elm.className="dead "+(e.dd?"d":"")),l&&e.elm.parentNode&&e.elm.parentNode.removeChild(e.elm)}),n.ani)})))}}function o(){n.sh.className="sh"+n.shA,n.scN.innerHTML=n.scA,n.blN.innerHTML=n.blA,n.shN.innerHTML="","de"!=n.tool&&n[n.tool+"A"]<=0&&n.tswp("de"),n.b<1&&r()}function i(t){if(n.block=!0,n.ex)return;n.ex=!0,setTimeout((()=>{l()}),10);let l=()=>{let l=e.cloneNode(!0);l.id="mC",l.className="z0",e.parentNode.appendChild(l),t?(n.lvl.lvl++,setTimeout((()=>{l.className="",document.getElementById("m2").className="tron";for(let e=0;e<l.getElementsByTagName("div").length;e++){let t=l.getElementsByTagName("div")[e];t.parentNode&&"row"===t.parentNode.className&&(t.style.backgroundColor="var(--g)",t.style.top=s(-500,500)+"px",t.style.left=s(-500,500)+"px",t.style.transform="rotate3d(1, 1, 1, "+s(-360,360)+"deg)")}setTimeout((()=>{d(n.lvl),setTimeout((()=>{document.getElementById("m2").className="",l.parentNode.removeChild(l)}),1)}),750)}),1)):(n.waN.innerHTML="Ship exploded",e.innerHTML="",setTimeout((()=>{l.className="";for(let e=0;e<l.getElementsByTagName("div").length;e++){let t=l.getElementsByTagName("div")[e];t.parentNode&&"row"===t.parentNode.className&&(t.style.left=s(-100,100)+"px",t.style.top=s(100,400)+"px",t.style.transform="rotate3d(1, 1, 1, "+s(-360,360)+"deg)",t.style.backgroundColor="var(--r)")}n.ss.style.transform="translate(0px, 50px) rotate3d(1, 1, 1, 240deg)",setTimeout((()=>{n.lvl={lvl:1},n.shA=1,n.blA=1,n.scA=2,setTimeout((()=>{l.parentNode.removeChild(l),d(n.lvl)}),n.ani)}),n.ani)}),n.ani))}}function r(){n.block=!0,clearInterval(n.loop),n.wa.style.setProperty("--w","200px"),n.waN.innerHTML="Warping Successful";for(let e=0;e<n.b&&n.dmg(-1);e++);n.shA>-1&&i(!0)}function d(t){t||(t={lvl:1}),clearInterval(n.loop),e.innerHTML="",n.tileSessionCount=0,n.t={},n.r={},n.tL=0,n.block=!1,n.wa.style.setProperty("--w","0px"),n.mi.classList.add("lvl"+t.lvl),n.ss.style.transform="translate("+45*(t.lvl-1)+"px, 0px) rotate(30deg)";let l=n.st+10*t.lvl;n.timer=l,n.tL=l,n.loop=setInterval((()=>{n.tL--;let e=200-n.timer/100*n.tL*2;n.wa.style.setProperty("--w",(e<0?0:e)+"px"),n.waN.innerHTML="Warping in "+n.tL,n.tL<=0&&r()}),1e3);const o=t.rows?t.rows:n.sRow+n.lvl.lvl,i=t.tr?t.tr:n.sRp+n.lvl.lvl;n.mb=t.b?t.b:n.bb+n.lvl.lvl,n.tr=i,n.rows=o;for(let t=0;t<o;t++){let l=document.createElement("div");l.className="row";for(let e=0;e<i;e++){let s=new a({row:t,rp:e});l.appendChild(s.elm)}e.appendChild(l)}nB=0;for(let e=0;e<n.mb;e++){let e=s(0,Object.keys(n.t).length-1),t=n.t[e];"b"===t.type?nB--:t.obj.gainType(t,"b")}for(let e=0;e<n.q;e++){let e=s(0,Object.keys(n.t).length-1),t=n.t[e];"?"===t.type&&t.obj.gainType(t,"q")}n.b=n.mb-nB,n.ga("bl",n.b),setTimeout((()=>{document.body.className="",n.ex=!1}),1),n.up()}n.boot=()=>{!function(){let e=e=>{let t=document.createElement("div");return t.id=e||"",t};n.wa=e("wa"),n.wa.appendChild(e("wa2")),n.waN=e("waN"),n.waN.innerHTML="Preparing warp drive",n.wa.appendChild(n.waN),l.appendChild(n.wa),n.sh=e("sh"),n.sh.appendChild(e("sh2")),n.shN=e("shN"),n.sh.appendChild(n.shN),l.appendChild(n.sh),n.mi=e("mi"),n.ss=e("ss"),n.ss.innerHTML="üöÄ",n.pl=e("pl"),n.pl.innerHTML="ü™ê",n.mi.appendChild(n.ss),n.mi.appendChild(e("mp")),n.mi.appendChild(n.pl),l.appendChild(n.mi),n.de=e("de"),n.de.className="s",n.de.innerHTML="<div>‚àû</div>",n.de.onclick=()=>{n.tswp("de")},t.appendChild(n.de),n.bl=e("bl"),n.blN=e("blN"),n.bl.appendChild(n.blN),n.bl.onclick=()=>{n.tswp("bl")},t.appendChild(n.bl),n.sc=e("sc"),n.scN=e("scN"),n.sc.appendChild(n.scN),n.sc.onclick=()=>{n.tswp("sc")},t.appendChild(n.sc),n.dmg=e=>(e<0&&(n.sh.style.backgroundColor="var(--d)",n.waN.innerHTML="Shield down",n.anim(document.body,"hit"),setTimeout((()=>{n.sh.style.backgroundColor="var(--m)"}),n.ani)),e<0&&Math.abs(e)>n.shA?(n.shA--,i(),!1):(n.shA=n.shA+e,n.shA>3&&(n.shA=3),o(),!0)),n.tswp=e=>{n.sc.className="",n.de.className="",n.bl.className="",e||(e="de"===n.tool?"bl":"bl"===n.tool?"sc":"de"),n[e].className="s",n.tool=e},n.anim=(e,t)=>{e.classList.add(t),setTimeout((()=>{e.classList.remove(t)}),n.ani)},n.ga=(e,t,l)=>{n.anim(n[e],t<0?"g-":"gg"),n[e+"N"].innerHTML=" +"+t,n[e+"A"]+=t,n.scA>3&&(n.scA=3)}}(),n.newGame=d,n.up=o,n.end=i,setTimeout((()=>{d()}),n.ani),document.body.oncontextmenu=e=>{e.preventDefault(),n.tswp()}};